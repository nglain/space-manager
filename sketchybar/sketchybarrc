#!/bin/bash

# SketchyBar - динамические spaces с переименованием

PLUGIN_DIR="$CONFIG_DIR/plugins"
NAMES_FILE="$HOME/.config/sketchybar/space_names.json"

# Создаём файл имён если не существует
if [ ! -f "$NAMES_FILE" ]; then
    echo '{}' > "$NAMES_FILE"
fi

# Настройки бара
sketchybar --bar \
    height=28 \
    position=top \
    padding_left=10 \
    padding_right=10 \
    color=0xff1e1e2e \
    shadow=on \
    sticky=on

# Настройки по умолчанию
sketchybar --default \
    icon.font="SF Pro:Bold:13.0" \
    label.font="SF Pro:Semibold:13.0" \
    icon.color=0xffffffff \
    label.color=0xffffffff \
    padding_left=3 \
    padding_right=3

# === ДИНАМИЧЕСКИЕ SPACES ===
# Получаем реальное количество spaces (только не-fullscreen, макс 10 для хоткеев)
TOTAL_SPACES=$(yabai -m query --spaces | jq '[.[] | select(."is-native-fullscreen"==false)] | length')
SPACE_COUNT=$((TOTAL_SPACES > 10 ? 10 : TOTAL_SPACES))

# Получаем индексы не-fullscreen spaces
NON_FS_INDICES=$(yabai -m query --spaces | jq -r '[.[] | select(."is-native-fullscreen"==false) | .index] | @sh' | tr -d "'")
NON_FS_ARRAY=($NON_FS_INDICES)

# Создаём spaces
for i in $(seq 0 $((SPACE_COUNT - 1))); do
    sid=$((i + 1))
    real_index=${NON_FS_ARRAY[$i]}

    # Получаем имя из файла или используем дефолтное
    name=$(jq -r ".\"$real_index\" // \"$sid\"" "$NAMES_FILE")

    sketchybar --add space space.$real_index left \
        --set space.$real_index \
            space=$real_index \
            icon="$name" \
            icon.padding_left=6 \
            icon.padding_right=6 \
            background.color=0xff363a4f \
            background.corner_radius=5 \
            background.height=22 \
            background.drawing=off \
            label.drawing=off \
            click_script="$PLUGIN_DIR/space_click.sh $real_index" \
            script="$PLUGIN_DIR/space.sh" \
        --subscribe space.$real_index space_change
done

# Разделитель
sketchybar --add item separator left \
    --set separator \
        icon="│" \
        icon.color=0xff6c7086 \
        label.drawing=off \
        padding_left=10 \
        padding_right=5

# === Правая сторона ===
sketchybar --add item clock right \
    --set clock \
        update_freq=30 \
        script="$PLUGIN_DIR/clock.sh"

sketchybar --add item battery right \
    --set battery \
        update_freq=120 \
        script="$PLUGIN_DIR/battery.sh"

sketchybar --update
