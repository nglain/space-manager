#!/bin/bash
# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –¢–û–õ–¨–ö–û –Ω–∞ —Ç–µ–∫—É—â–µ–º desktop –≤ Stickies

LOG="/tmp/terminals-here.log"
echo "=== $(date) ===" > "$LOG"

# Python —Å –º–æ–¥—É–ª–µ–º Quartz (anaconda)
PYTHON="/opt/anaconda3/bin/python3"

echo "Python: $PYTHON" >> "$LOG"

# –ü–æ–ª—É—á–∞–µ–º –æ–∫–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ desktop —á–µ—Ä–µ–∑ Quartz API
TERMINALS=$("$PYTHON" - << 'PYEOF' 2>> "$LOG"
import Quartz

windows = Quartz.CGWindowListCopyWindowInfo(
    Quartz.kCGWindowListOptionOnScreenOnly | Quartz.kCGWindowListExcludeDesktopElements,
    Quartz.kCGNullWindowID
)

terminals = []
for w in windows:
    owner = w.get('kCGWindowOwnerName', '')
    name = w.get('kCGWindowName', '')
    if owner in ('Terminal', '–¢–µ—Ä–º–∏–Ω–∞–ª') and name:
        if len(name) > 55:
            name = name[:55] + "..."
        terminals.append(name)

output = f"üñ• –¢–ï–†–ú–ò–ù–ê–õ–´ ({len(terminals)}):\n\n"
for i, name in enumerate(terminals, 1):
    output += f"{i}. {name}\n"

if not terminals:
    output += "(–Ω–µ—Ç –æ–∫–æ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)"

print(output)
PYEOF
)

echo "Terminals found: ${#TERMINALS}" >> "$LOG"
echo "$TERMINALS" >> "$LOG"

# –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä
echo "$TERMINALS" | /usr/bin/pbcopy

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—É—Ñ–µ—Ä
echo "Clipboard: $(/usr/bin/pbpaste | head -1)" >> "$LOG"

# –ñ–¥—ë–º
sleep 0.3

# –û—Ç–∫—Ä—ã–≤–∞–µ–º Stickies –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º
/usr/bin/osascript << 'EOF' 2>> "$LOG"
tell application "Stickies" to quit
delay 0.8

tell application "Stickies" to activate
delay 1

tell application "System Events"
    tell process "Stickies"
        set frontmost to true
        delay 0.3

        -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–∫–Ω–æ
        if (count of windows) = 0 then
            click menu item "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å–∫–∞" of menu "–§–∞–π–ª" of menu bar 1
            delay 0.5
        end if

        -- –í—Å—Ç–∞–≤–ª—è–µ–º
        click menu item "–í—Å—Ç–∞–≤–∏—Ç—å" of menu "–ü—Ä–∞–≤–∫–∞" of menu bar 1
    end tell
end tell
EOF

echo "Done" >> "$LOG"
